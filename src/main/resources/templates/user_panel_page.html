<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Rental Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/1571ce0189.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/user_panel_page_style.css}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
<header>
    <div class="top-bar">
        <button type="button" class="btn btn-secondary menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-bars"></i> Menu
        </button>
        <h1>
            <span th:if="${loggedInUser}" th:text="${'Witaj, ' + loggedInUser.firstName + ' ' + loggedInUser.lastName + '!'}"></span>
        </h1>
        <div class="auth-buttons">
            <span th:if="${loggedInUser}">
                <button type="button" class="btn btn-secondary logout-button" onclick="logout()">Wyloguj się</button>
            </span>
            <span th:unless="${loggedInUser}">
                <button type="button" class="btn btn-secondary login-button" onclick="redirectToLogin()">Zaloguj</button>
                <span class="spacing"></span>
                <button type="button" class="btn btn-secondary register-button" onclick="redirectToRegister()">Rejestracja</button>
            </span>
        </div>
    </div>
</header>

<div class="toolbar-menu">
    <div class="toolbar">
        <div class="toolbar-top"></div>
    </div>

    <nav class="side-menu">
        <button type="button" class="btn btn-secondary menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-times"></i> Zamknij
        </button>
        <a href="/main_page">Strona główna</a>
        <span th:if="${loggedInUser}">
            <a href="/user_panel">Panel użytkownika</a>
        </span>
        <a href="/contact_us">Kontakt</a>
        <span th:if="${role eq 'Administrator'}">
        <a href="/admin_panel">Panel administratora</a>
        </span>
    </nav>
</div>

<span th:if="${role eq 'Najemca'}">
<div class="container">
    <h1 class="hCenter">Twoje umowy najmu</h1>
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Numer umowy (ID)</th>
            <th>Data rozpoczęcia</th>
            <th>Data zakończenia</th>
            <th>Kwota najmu (zł)</th>
            <th>Nieruchomość (adres)</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="rentalAgreement : ${rentalAgreements}">
            <td th:text="${rentalAgreement.agreementId}"></td>
            <td th:text="${rentalAgreement.startDate}"></td>
            <td th:text="${rentalAgreement.endDate}"></td>
            <td th:text="${rentalAgreement.rentAmount}"></td>
            <td th:text="${rentalAgreement.property.address}"></td>
        </tr>
        </tbody>
    </table>
</div>
</span>

<span th:if="${role eq 'Wynajmujacy'}">
    <div class="container">
        <div class="landlord-container-1">
            <h2 class="hCenter">Twoje nieruchomości</h2>
            <ul>
                <li th:each="property : ${properties}"><i class="fa fa-building" aria-hidden="true"></i>
                    <span th:text="${property.address}"></span>
                </li>
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="landlord-container">
            <h2 class="hCenter">Zarządzanie czynszem i opłatami za media</h2>

           <form method="post" id="rentAndUtilitiesForm" action="/payUtilities/">
                <label for="property">Wybierz nieruchomość:</label>
                <select name="property" id="property" onchange="updateUtilitiesStatus()">
                    <option value="">Wybierz nieruchomość</option>
                    <option th:each="property : ${properties}" th:value="${property.propertyId}" th:text="${property.address}"></option>
                </select>
                <p id="utilitiesStatus">Status opłat za media: </p>
                <p id="utilitiesMonth">Opłata za miesiąc: </p>
                <p id="utilitiesId">ID płatności: </p>
                <p id="utilitiesAmount">Kwota za media: </p>
               <button type="submit">Opłać</button>
            </form>

            <div class="wallet-info">
                    Portfel: <span th:text="${walletBalance}"></span> PLN
            </div>

            <form method="post" id ="rentAndInvoiceForm" action="/createInvoice">
                <p id="rentStatus">Status opłaty czynszu przez najemcę: </p>
                <button type="submit">Wystaw fakturę</button>
            </form>

        </div>
    </div>
    <div class="container">
        <h2 class="hCenter">Rozliczenia opłat za media w poszczególnych miesiącach</h2>
        <canvas id="utilitiesChart" width="800" height="400"></canvas>
    </div>
</span>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Funkcja obsługująca opłacanie płatności za media
        function createInvoice(propertyId) {
            var xhr = new XMLHttpRequest();

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Pomyślnie
                        alert("Faktura została wystawiona.");
                        // Możesz też wykonać dodatkowe operacje, np. przeładować stronę
                        window.location.reload();
                    } else {
                        // Wystąpił błąd podczas wystawiania faktury
                        alert("Wystąpił błąd podczas wystawiania faktury. Spróbuj ponownie później.");
                        console.error("Błąd żądania AJAX:", xhr.status);
                    }
                }
            };

            xhr.open("POST", "/createInvoice");
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send("propertyId=" + propertyId);
        }

        // Funkcja obsługująca kliknięcie przycisku "Wystaw fakturę" w formularzu
        function handleInvoice() {
            document.getElementById("rentAndInvoiceForm").addEventListener("submit", function(event) {
                event.preventDefault(); // Zapobiegamy domyślnej akcji formularza (czyli wysłaniu żądania POST)

                var propertyId = document.getElementById("property").value;


                createInvoice(propertyId);

            });
        }

        // Wywołaj funkcję obsługującą płatność po załadowaniu strony
        handleInvoice();
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Funkcja obsługująca opłacanie płatności za media
        function payUtilities(paymentId) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        // Pomyślnie opłacono płatność, możesz wykonać odpowiednie działania
                        alert("Płatność za media została pomyślnie opłacona.");
                        // Możesz też wykonać dodatkowe operacje, np. przeładować stronę
                        window.location.reload();
                    } else {
                        // Wystąpił błąd podczas opłacania płatności
                        alert("Wystąpił błąd podczas opłacania płatności. Spróbuj ponownie później.");
                        console.error("Błąd żądania AJAX:", xhr.status);
                    }
                }
            };
            xhr.open("POST", "/payUtilities/" + paymentId);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.send(JSON.stringify({ status: "paid" }));
        }

        // Funkcja obsługująca kliknięcie przycisku "Opłać" w formularzu
        function handlePayment() {
            document.getElementById("rentAndUtilitiesForm").addEventListener("submit", function(event) {
                event.preventDefault(); // Zapobiegamy domyślnej akcji formularza (czyli wysłaniu żądania POST)

                // var propertyId = document.getElementById("property").value;
                var paymentIdString = document.getElementById("utilitiesId").textContent.trim(); // Pobieramy ID płatności jako tekst
                var paymentId = parseInt(paymentIdString.replace('ID płatności:', '').trim()); // Konwertujemy tekst na liczbę całkowitą
                if (paymentId  !== '') {
                    // Jeśli wybrano nieruchomość, wykonaj płatność
                    payUtilities(paymentId );
                } else {
                    // Jeśli nie wybrano nieruchomości, wyświetl komunikat
                    alert("Wybierz nieruchomość przed opłaceniem płatności za media.");
                }
            });
        }

        // Wywołaj funkcję obsługującą płatność po załadowaniu strony
        handlePayment();
    });
</script>
<script>
    // Dane do wykresu - pobierz z modelu Thymeleaf
    var utilitiesData = [];

    function generateChart() {
        var months = utilitiesData.map(entry => entry.month);
        var amounts = utilitiesData.map(entry => entry.amount);

        console.log('Months:', months);
        console.log('Amounts:', amounts);

        // Znajdź istniejący wykres
        var existingChart = Chart.getChart("utilitiesChart");
        // Jeśli istnieje, zniszcz go
        if (existingChart) {
            existingChart.destroy();
        }

        var ctx = document.getElementById('utilitiesChart').getContext('2d');
        var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: months,
                datasets: [{
                    label: 'Kwota za media (PLN)',
                    data: amounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        });
    }

    function updateUtilitiesStatus() {
        // Znajdź istniejący wykres
        var existingChart = Chart.getChart("utilitiesChart");
        // Jeśli istnieje, zniszcz go
        if (existingChart) {
            existingChart.destroy();
        }
        var propertyId = document.getElementById('property').value;
        console.log('Wybrano nieruchomość o ID:', propertyId);
        if (propertyId !== '') {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var utilitiesStatus = response.status;
                        var utilitiesAmount = response.amounts;
                        var latestAmount = response.latestAmount;
                        var paymentIdForProperty = response.paymentIdForProperty;
                        // Mapowanie miesięcy na polskie nazwy
                        const mapMonth = month => {
                            switch (month) {
                                case 'January': return 'Styczeń';
                                case 'February': return 'Luty';
                                case 'March': return 'Marzec';
                                case 'April': return 'Kwiecień';
                                case 'May': return 'Maj';
                                case 'June': return 'Czerwiec';
                                case 'July': return 'Lipiec';
                                case 'August': return 'Sierpień';
                                case 'September': return 'Wrzesień';
                                case 'October': return 'Październik';
                                case 'November': return 'Listopad';
                                case 'December': return 'Grudzień';
                                default: return month;
                            }
                        };
                        const utilitiesMonths = response.months.map(mapMonth);
                        const paymentMonth = mapMonth(response.paymentMonth);

                        var rentStatus = response.rentStatus;

                        console.log('Status opłat za media:', utilitiesStatus);
                        console.log('Kwota za media:', utilitiesAmount);
                        console.log('Miesiące:', utilitiesMonths.join(', '));
                        console.log("Najnowsza kwota w tabeli: ", latestAmount);
                        console.log("Opłata za miesiąc: ", paymentMonth);
                        console.log("ID płatności: ", paymentIdForProperty);

                        console.log("Status opłaty za czynsz: ", rentStatus);

                        document.getElementById('utilitiesStatus').textContent = 'Status opłat za media: ' + utilitiesStatus;
                        document.getElementById('utilitiesAmount').textContent = 'Kwota za media: ' + latestAmount;
                        document.getElementById('utilitiesId').textContent = 'ID płatności:' + paymentIdForProperty;

                        document.getElementById("rentStatus").textContent = "Status opłaty czynszu przez najemcę: " + rentStatus;


                        if (utilitiesStatus === 'Opłata za media nie została jeszcze dokonana.') {
                            document.getElementById('utilitiesMonth').textContent = 'Opłata za miesiąc: ' + paymentMonth;
                        } else {
                            document.getElementById('utilitiesMonth').textContent = 'Opłata za miesiąc: brak zaległych opłat';
                        }

                        if (utilitiesStatus === 'Opłacone') {
                            utilitiesData = [];
                            for (var i = 0; i < utilitiesMonths.length; i++) {
                                utilitiesData.push({ month: utilitiesMonths[i], amount: utilitiesAmount[i] });
                            }
                            generateChart();
                        }
                    } else {
                        console.error('Błąd żądania AJAX:', xhr.status);
                    }
                }
            };
            xhr.open('GET', '/getUtilitiesStatus/' + propertyId);
            xhr.send();
        } else {
            document.getElementById('utilitiesStatus').textContent = 'Status opłat za media: ';
            document.getElementById('utilitiesAmount').textContent = 'Kwota za media: ';
            document.getElementById('utilitiesMonth').textContent = 'Opłata za miesiąc: ';
        }
    }
</script>
<script>
    function toggleMenu() {
        var sideMenu = document.querySelector('.side-menu');
        sideMenu.classList.toggle('open');
    }

    function redirectToLogin() {
        window.location.href = "/login";
    }

    function redirectToRegister() {
        window.location.href = "/register";
    }

    function logout() {
        // W tym miejscu możesz wykonać operacje związane z wylogowywaniem,
        // np. zakończenie sesji, usuwanie atrybutu 'loggedInUser' itp.

        // Następnie przekieruj użytkownika na stronę wylogowania
        window.location.href = "/logout";  // Zakładając, że masz endpoint '/logout' do obsługi wylogowywania
    }
</script>
</body>
</html>