<html lang="pl" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Rent&Gain Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://kit.fontawesome.com/1571ce0189.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" th:href="@{/css/suggestions_and_analyses_page_style.css}">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>

<body>
<header>
    <div class="top-bar">
        <button type="button" class="btn btn-secondary menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-bars"></i> Menu
        </button>
        <h1>
            <span th:if="${loggedInUser}" th:text="${'Witaj, ' + loggedInUser.firstName + ' ' + loggedInUser.lastName + '!'}"></span>
        </h1>
        <div class="auth-buttons">
            <span th:if="${loggedInUser}">
                <button type="button" class="btn btn-secondary logout-button" onclick="logout()">Wyloguj się</button>
            </span>
            <span th:unless="${loggedInUser}">
                <button type="button" class="btn btn-secondary login-button" onclick="redirectToLogin()">Zaloguj</button>
                <span class="spacing"></span>
                <button type="button" class="btn btn-secondary register-button" onclick="redirectToRegister()">Rejestracja</button>
            </span>
        </div>
    </div>
</header>

<div class="toolbar-menu">
    <div class="toolbar">
        <div class="toolbar-top"></div>
    </div>

    <nav class="side-menu">
        <button type="button" class="btn btn-secondary menu-toggle" onclick="toggleMenu()">
            <i class="fas fa-times"></i> Zamknij
        </button>
        <a href="/main_page">Strona główna</a>
        <span th:if="${loggedInUser}">
            <a href="/user_panel">Panel użytkownika</a>
        </span>
        <span th:if="${role eq 'Wynajmujacy'}">
            <a href="/taxes_page">Podatki</a>
        </span>
        <span th:if="${role eq 'Wynajmujacy'}">
            <a href="/suggestions_and_analyses">Sugestie i analizy</a>
        </span>
        <a href="/contact_us">Kontakt</a>
        <span th:if="${role eq 'Administrator'}">
        <a href="/admin_panel">Panel administratora</a>
        </span>
    </nav>
</div>

<div class="container">
    <h3 class = "hCenter">Wszystkie przychody z nieruchomości</h3>
    <div id="charts-container">
        <!-- Kontener dla wykresu -->
        <div id="chart" th:data-property-data-json="${propertyDataJson}"></div>
        <div th:if="${jsonError}" class="alert alert-danger" role="alert">
            [[${jsonError}]]
        </div>
    </div>
</div>
<div class="container">
    <h3 class="hCenter">Roczne przychody z nieruchomości</h3>
    <div class="year-selection">
        <label for="yearSelect">Wybierz rok:</label>
        <select id="yearSelect"></select>
    </div>
    <div id="annualChart" th:data-annual-incomes-json="${annualIncomesJson}"></div>
</div>

<div class="container" id="lastRentInfo" th:data-last-rent-infos-json="${lastRentInfosJson}">
    <h3 class="hCenter">Sugestie dotyczące optymalizacji zysku</h3>
    <hr class="hr-1">
    <h4>Podwyższenie czynszu za wynajem</h4>
    <p>Rozważ podwyższnie czynszu dla najemców. Skorzystaj z poniższego kalkulatora, aby przeanalizować przychód przed i po podwyżce czynszu o dany procent. Dane dotyczące przewidywanego przychodu do końca roku zostały pobrane z bazy danych. </p>
    <label for="percentIncrease">Wybierz procentową podwyżkę:</label>
    <select id="percentIncrease">
        <option value="10">10%</option>
        <option value="15">15%</option>
        <option value="20">20%</option>
        <option value="25">25%</option>
        <option value="30">30%</option>
        <option value="35">35%</option>
        <option value="40">40%</option>
    </select>
    <p>Do końca roku za pozostałe miesiące przychód będzie wynosił:</p>
    <p id="incomeWithoutIncrease"><b>bez podwyżki czynszu:</b> </p>
    <p id="incomeWithIncrease"><b>z podwyżką czynszu:</b> </p>
    <hr class="hr-1">
    <h4>Reklama lokalu użytkowego</h4>
    <p>Korzystaj z wielu kanałów reklamowych, takich jak portale nieruchomości lub media społecznościowe, aby dotrzeć do szerszej grupy potencjalnych najemców.</p>
    <hr class="hr-1">
    <h4>Efektywność energetyczna</h4>
    <p>Zainwestuj w energooszczędne urządzenia i instalacje (np. oświetlenie LED, nowoczesne okna), aby obniżyć rachunki za media.</p>
    <hr class="hr-1">
    <h4>Renowacje i modernizacje</h4>
    <p>Przeprowadź modernizacje, które zwiększą atrakcyjność nieruchomości (np. nowa kuchnia, łazienka, podłogi).</p>
    <hr class="hr-1">
    <h4>Relacje z najemcami</h4>
    <p>Buduj pozytywne relacje z najemcami, reagując szybko na ich potrzeby i problemy. Zadowoleni najemcy są bardziej skłonni do przedłużania umowy.</p>
    <hr class="hr-1">
    <h4>Ulgi podatkowe</h4>
    <p>Skonsultuj się z doradcą podatkowym, aby skorzystać z dostępnych ulg i odliczeń podatkowych związanych z wynajmem nieruchomości.</p>
</div>

<div class="container">
    <h3 class="hCenter">Sugestie dobierania najemców</h3>
    <br>
    <p>Poniżej prezentujemy listę nieruchomości, których jesteś właścicielem, wraz z ich typami, oraz zestawienie potencjalnych najemców, którzy wyrazili zainteresowanie danym typem nieruchomości. Wszystkie dane pobierane są bezpośrednio z naszej bazy danych, aby zapewnić aktualność informacji.</p>
    <hr class="hr-1">
    <div th:each="property : ${properties}">
        <p><span class="tenants-selecting"><b>Lokal: </b><span th:text="${property.address}"></span></span></p>
        <p><span class="tenants-selecting"><b>Typ lokalu: </b><span th:each="type : ${typesOfProperties}" th:if="${type != null and type.typeId == property.typeId}">
                <span th:text="${type.kind}"></span>
        </span></span></p>
        <p><span class="tenants-selecting"><b>Lista potencjalnych najemców:</b></span></p>
        <ul>
            <li th:each="tenant : ${tenants}" th:if="${tenant.preferredKindOfProperty == property.typeId}">
                <span class="tenants-selecting"><span th:text="${@tenantService.getFullNameByTenantId(tenant.tenantId)}"></span>, nr tel.: <span th:text="${tenant.phoneNumber}"></span></span>
            </li>
        </ul>
        <hr class="hr-1">
    </div>
</div>

<div class="container">
    <h3 class="hCenter">Ryzyko najmu</h3>
    <br>
    <p>Analiza ryzyka najmu to kluczowy element dla właścicieli nieruchomości oraz osób zarządzających wynajmem lokali. Poniżej przedstawiamy kilka metod weryfikacji najemcy.</p>
    <hr class="hr-1">
    <h4>Rozmowa</h4>
    <p>Jednym z łatwych sposobów sprawdzenia wiarygodności najemcy jest przeprowadzenie rozmowy. Jeśli potencjalny najemca unika odpowiedzi
        na proste pytania, takie jak dotychczasowe miejsce zamieszkania czy powód zakończenia poprzedniego najmu,
        może to być powodem do zaniepokojenia dla wynajmującego. Innym sygnałem ostrzegawczym może być nagłe naciskanie
        na szybkie podjęcie decyzji. Jeśli kandydat na najemcę sugeruje możliwość natychmiastowego wprowadzenia się i
        pilnie prosi o wydanie kluczy, warto to skrupulatnie rozważyć.</p>
    <hr class="hr-1">
    <h4>Oświadczenie co do zaległych opłat</h4>
    <p>Mało używanym, lecz skutecznym narzędziem zabezpieczającym wynajmującego przed ryzykiem związanych z brakiem płatności jest
        oświadczenie najemcy o poddaniu się egzekucji co do zapłaty zaległych opłat.
        Ten dokument, sporządzany w formie aktu notarialnego, ustala maksymalną kwotę, za którą najemca będzie odpowiedzialny.
        Zazwyczaj obejmuje ona sumę wszystkich należności z tytułu najmu przez cały okres umowy,
        włączając w to czynsz oraz inne opłaty związane z użytkowaniem lokalu. W przypadku wystąpienia zaległości,
        zamiast angażować się w długotrwałe procesy sądowe, wystarczy złożyć ten akt w sądzie wraz z wnioskiem o jego wykonanie,
        a następnie skierować sprawę do komornika w celu odzyskania należności.</p>
    <p>Pobierz przykładową umowę najmu lokalu użytkowego <a th:href="@{/docx/umowa-najmu-lokalu-uzytkowego.doc}" download="umowa-najmu-lokalu-uzytkowego.doc">tutaj</a></p>
    <br>
    <p>Pobierz sam paragraf do umowy <a th:href="@{/docx/paragraf.docx}" download="paragraf.docx">tutaj</a></p>
    <hr class="hr-1">
    <h4>Narzędzia do weryfikacji najemcy</h4>
    <p>Sprawdzenie wiarygodności najemcy można również dokonać przy użyciu dedykowanych narzędzi dostępnych na rynku.
        Jednym z takich narzędzi jest Certyfikat Najemcy, który jest oferowany przez platformę <a href="https://simpl.rent/wlasciciel/">simpl.rent</a>.
        Proces weryfikacji przeprowadzany za pomocą tej aplikacji pozwala w trzech prostych krokach zweryfikować tożsamość,
        dochody oraz historię kredytową potencjalnego lokatora.</p>
    <hr class="hr-1">
    <h4>Dochody najemcy</h4>
    <p>Należy pamiętać, że umowa najmu to formalny dokument, który wiąże obie strony kontraktu.
        Wynajmujący zobowiązuje się przekazać swoją własność na długi okres czasu w wyłączne użytkowanie najemcy.
        Z kolei najemca, korzystając z uprzywilejowanej pozycji wynikającej z przepisów prawa dotyczących ochrony praw lokatorów,
        ma pewne prawa. Dlatego też istotne jest już na etapie przed podpisaniem umowy ustalenie,
        czy najemca będzie w stanie sprostać swoim zobowiązaniom. W tym kontekście,
        prośba o udokumentowanie źródeł dochodów nie powinna budzić większych zastrzeżeń.</p>
    <hr class="hr-1">
</div>


<script>
    document.addEventListener("DOMContentLoaded", function() {
        console.log("DOM fully loaded and parsed");

        var lastRentInfoElement = document.getElementById("lastRentInfo");
        var incomeWithoutIncreaseElement = document.getElementById("incomeWithoutIncrease");
        var incomeWithIncreaseElement = document.getElementById("incomeWithIncrease");
        var percentIncreaseSelect = document.getElementById("percentIncrease");

        function calculateIncome() {
        if (lastRentInfoElement) {
            console.log("Found last rent info element");

            try {
                var lastRentInfoJson = lastRentInfoElement.dataset.lastRentInfosJson;
                console.log("Last rent info JSON:", lastRentInfoJson);

                var lastRentInfo = JSON.parse(lastRentInfoJson);
                console.log("Parsed last rent info:", lastRentInfo);

                var percentIncrease = parseInt(percentIncreaseSelect.value) / 100;
                console.log("Percent increase:", percentIncrease);

                var currentMonth = new Date().getMonth() + 1;
                var monthsLeftInYear = 12 - currentMonth;

                var incomeWithoutIncrease = Object.values(lastRentInfo).reduce(function(acc, rentPayment) {
                    var paymentMonth = new Date(rentPayment.issueDate).getMonth() + 1;
                    var monthsLeft = 12 - paymentMonth;
                    return acc + (rentPayment.paymentAmount * monthsLeft);
                }, 0);

                console.log("Income without increase:", incomeWithoutIncrease);

                var incomeWithIncrease = Object.values(lastRentInfo).reduce(function(acc, rentPayment) {
                    var paymentMonth = new Date(rentPayment.issueDate).getMonth() + 1;
                    var monthsLeft = 12 - paymentMonth;
                    return acc + (rentPayment.paymentAmount * (1+percentIncrease) * monthsLeft);
                }, 0);

                console.log("Income with increase:", incomeWithIncrease);

                incomeWithoutIncreaseElement.textContent = "bez podwyżki czynszu: " + incomeWithoutIncrease.toFixed(2);
                incomeWithIncreaseElement.textContent = "z podwyżką czynszu: " + incomeWithIncrease.toFixed(2);
            } catch (e) {
                console.error("Error processing last rent info JSON:", e);
            }
        }
    }

    percentIncreaseSelect.addEventListener("change", calculateIncome);

    calculateIncome();
    });
</script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chartElement = document.querySelector("#chart");
        var propertyDataJson = chartElement.dataset.propertyDataJson;

        if (propertyDataJson) {
            try {
                var propertyData = JSON.parse(propertyDataJson);

                var propertyNames = [];
                var propertyIncomesData = [];

                propertyData.forEach(function(property) {
                    propertyNames.push(property.address);
                    propertyIncomesData.push(property.income);
                });

                var options = {
                    series: [{
                        name: 'Przychody z nieruchomości',
                        data: propertyIncomesData
                    }],
                    chart: {
                        type: 'bar',
                        height: 350
                    },
                    xaxis: {
                        categories: propertyNames,
                        labels: {
                            rotate: -45,
                            style: {
                                colors: [],
                                fontSize: '12px',
                                fontFamily: 'Helvetica, Arial, sans-serif',
                                fontWeight: 400,
                            }
                        },
                        title: {
                            text: 'Nieruchomości',
                            style: {
                                fontSize: '14px',
                                fontWeight: 'bold',
                                fontFamily: 'Helvetica, Arial, sans-serif',
                                color: '#263238'
                            }
                        }
                    },
                    yaxis: {
                        title: {
                            text: 'Przychody (PLN)',
                            style: {
                                fontSize: '14px',
                                fontWeight: 'bold',
                                fontFamily: 'Helvetica, Arial, sans-serif',
                                color: '#263238'
                            }
                        }
                    },
                    tooltip: {
                        y: {
                            formatter: function (val) {
                                return val + " PLN";
                            }
                        }
                    },
                    title: {
                        text: `Łączny przychód z wynajmu od momentu posiadania nieruchomości`,
                        align: 'center',
                        style: {
                            fontSize: '20px',
                            fontWeight: 'bold',
                            fontFamily: 'Helvetica, Arial, sans-serif',
                            color: '#263238'
                        }
                    }
                };

                var chart = new ApexCharts(chartElement, options);
                chart.render();
            } catch (e) {
                console.error("Error parsing property data JSON:", e);
            }
        } else {
            console.error("Property data JSON is undefined");
        }


        var annualChartElement = document.querySelector("#annualChart");
        var annualIncomesJson = annualChartElement.getAttribute("data-annual-incomes-json");
        console.log("Annual incomes JSON:", annualIncomesJson);

        var yearSelect = document.getElementById("yearSelect");

        if (annualIncomesJson) {
            try {
                var annualIncomes = JSON.parse(annualIncomesJson);
                console.log("Parsed annual incomes:", annualIncomes);

                var availableYears = new Set();
                Object.values(annualIncomes).forEach(incomesPerProperty => {
                    Object.keys(incomesPerProperty).forEach(year => {
                        availableYears.add(year);
                    });
                });

                availableYears = Array.from(availableYears).sort();
                console.log("Available years:", availableYears);

                availableYears.forEach(year => {
                    var option = document.createElement("option");
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });

                var annualChart;

                function renderAnnualChart(year) {
                    var propertyNames = [];
                    var annualIncomesData = [];

                    Object.keys(annualIncomes).forEach(propertyAddress => {
                        var incomeForYear = annualIncomes[propertyAddress][year] || 0;
                        propertyNames.push(propertyAddress);
                        annualIncomesData.push(incomeForYear);
                    });

                    var annualOptions = {
                        series: [{
                            name: `Przychody za ${year}`,
                            data: annualIncomesData
                        }],
                        chart: {
                            type: 'bar',
                            height: 350,
                            animations: {
                                enabled: true,
                                easing: 'easeinout',
                                speed: 800,
                                animateGradually: {
                                    enabled: true,
                                    delay: 150
                                },
                                dynamicAnimation: {
                                    enabled: true,
                                    speed: 350
                                }
                            }
                        },
                        colors: ['#59c1ff'],
                        plotOptions: {
                            bar: {
                                borderRadius: 4,
                                horizontal: false,
                            },
                        },
                        dataLabels: {
                            enabled: false
                        },
                        xaxis: {
                            categories: propertyNames,
                            labels: {
                                rotate: -45,
                                style: {
                                    colors: [],
                                    fontSize: '12px',
                                    fontFamily: 'Helvetica, Arial, sans-serif',
                                    fontWeight: 400,
                                }
                            },
                            title: {
                                text: 'Nieruchomości',
                                style: {
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    fontFamily: 'Helvetica, Arial, sans-serif',
                                    color: '#263238'
                                }
                            }
                        },
                        yaxis: {
                            title: {
                                text: 'Przychody (PLN)',
                                style: {
                                    fontSize: '14px',
                                    fontWeight: 'bold',
                                    fontFamily: 'Helvetica, Arial, sans-serif',
                                    color: '#263238'
                                }
                            }
                        },
                        title: {
                            text: `Przychody za ${year}`,
                            align: 'center',
                            style: {
                                fontSize: '20px',
                                fontWeight: 'bold',
                                fontFamily: 'Helvetica, Arial, sans-serif',
                                color: '#263238'
                            }
                        },
                        tooltip: {
                            y: {
                                formatter: function (val) {
                                    return val + " PLN";
                                }
                            }
                        },
                        theme: {
                            mode: 'light',
                            palette: 'palette1',
                            monochrome: {
                                enabled: false,
                                color: '#008FFB',
                                shadeTo: 'light',
                                shadeIntensity: 0.65
                            },
                        }
                    };

                    if (annualChart) {
                        annualChart.destroy();
                    }

                    annualChart = new ApexCharts(annualChartElement, annualOptions);
                    annualChart.render();
                }

                renderAnnualChart(availableYears[0]);

                yearSelect.addEventListener("change", function() {
                    var selectedYear = yearSelect.value;
                    renderAnnualChart(selectedYear);
                });
            } catch (e) {
                console.error("Error parsing annual incomes JSON:", e);
            }
        } else {
            console.error("Annual incomes JSON is undefined");
        }
    });
</script>
<script>
    function toggleMenu() {
        var sideMenu = document.querySelector('.side-menu');
        sideMenu.classList.toggle('open');
    }

    function redirectToLogin() {
        window.location.href = "/login";
    }

    function redirectToRegister() {
        window.location.href = "/register";
    }

    function logout() {
        window.location.href = "/logout";
    }
</script>
</body>
</html>